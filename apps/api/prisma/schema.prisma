generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  OWNER
  ADMIN
  MANAGER
  EMPLOYEE
  FINANCE_READONLY
}

enum RoleScopeType {
  TENANT
  PROJECT
  TEAM
}

enum UserStatus {
  ACTIVE
  DISABLED
}

enum EmployeeStatus {
  ACTIVE
  INACTIVE
}

enum ProjectStatus {
  ACTIVE
  ARCHIVED
}

enum TimeEntrySource {
  MANUAL
  CALENDAR_SUGGESTION
  IMPORT
}

enum CalendarProvider {
  GOOGLE
  MICROSOFT
}

enum ConnectionStatus {
  ACTIVE
  REVOKED
  ERROR
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  ERROR
}

enum ReportType {
  TIME_ENTRIES_CSV
  TIME_ENTRIES_PDF
  PROJECT_SUMMARY
}

enum JobStatus {
  PENDING
  RUNNING
  DONE
  FAILED
}

enum ClientStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum ProjectBudgetType {
  FIXED
  HOURLY_RATE
}

model Tenant {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  users               User[]
  userRoles           UserRole[]
  employees           Employee[]
  projects            Project[]
  projectMembers      ProjectMember[]
  timeEntries         TimeEntry[]
  calendarConnections CalendarConnection[]
  calendarEvents      CalendarEvent[]
  calendarSubscriptions CalendarSubscription[]
  reportJobs          ReportJob[]
  auditLogs           AuditLog[]
  clients             Client[]
  timeAllocations     TimeAllocation[]
  projectBudgets      ProjectBudget[]

  @@map("tenants")
}

model User {
  id           String   @id @default(uuid()) @db.Uuid
  tenantId     String   @map("tenant_id") @db.Uuid
  email        String
  username     String?
  passwordHash String   @map("password_hash")
  status       UserStatus @default(ACTIVE)
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz

  tenant       Tenant   @relation(fields: [tenantId], references: [id])
  roles        UserRole[]
  refreshTokens RefreshToken[]
  employee     Employee?

  calendarConnections CalendarConnection[]
  
  createdTimeEntries TimeEntry[] @relation("CreatedBy")
  updatedTimeEntries TimeEntry[] @relation("UpdatedBy")
  
  requestedReports ReportJob[]
  auditLogs        AuditLog[]

  @@unique([tenantId, email])
  @@unique([tenantId, username])
  @@map("users")
}

model UserRole {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  role      Role
  scopeType RoleScopeType @default(TENANT) @map("scope_type")
  scopeId   String?  @map("scope_id") @db.Uuid

  tenant    Tenant   @relation(fields: [tenantId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([tenantId, userId, role, scopeType, scopeId])
  @@map("user_roles")
}

model RefreshToken {
  id        String   @id @default(uuid()) @db.Uuid
  tenantId  String   @map("tenant_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  tokenHash String   @unique @map("token_hash")
  expiresAt DateTime @map("expires_at") @db.Timestamptz
  revokedAt DateTime? @map("revoked_at") @db.Timestamptz
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  user      User     @relation(fields: [userId], references: [id])

  @@map("refresh_tokens")
}

model Employee {
  id           String   @id @default(uuid()) @db.Uuid
  tenantId     String   @map("tenant_id") @db.Uuid
  userId       String?  @unique @map("user_id") @db.Uuid
  firstName    String   @map("first_name")
  lastName     String   @map("last_name")
  employeeCode String?  @map("employee_code")
  email        String?
  status       EmployeeStatus @default(ACTIVE)

  // Enhanced fields for employee management
  position     String?
  department   String?
  level        String?
  salary       Decimal? @db.Decimal(10, 2)
  currency     String?  @default("USD")
  hourlyRate   Decimal? @map("hourly_rate") @db.Decimal(10, 2)

  // Manager hierarchy (simple one-to-one)
  managerId    String?  @map("manager_id") @db.Uuid

  // Capacity and experience
  monthlyCapacity    Decimal? @map("monthly_capacity") @db.Decimal(10, 2) @default(160.00)
  yearsOfExperience  Decimal? @map("years_of_experience") @db.Decimal(4, 1)
  hireDate           DateTime? @map("hire_date") @db.Date

  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz

  tenant       Tenant   @relation(fields: [tenantId], references: [id])
  user         User?    @relation(fields: [userId], references: [id])

  // Manager relationship
  manager      Employee?  @relation("EmployeeManager", fields: [managerId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  subordinates Employee[] @relation("EmployeeManager")

  projectMembers  ProjectMember[]
  timeEntries     TimeEntry[]
  timeAllocations TimeAllocation[]
  managedProjects Project[] @relation("ProjectManager")

  @@map("employees")
}

model Project {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  name        String
  code        String?
  description String?
  status      ProjectStatus @default(ACTIVE)
  startDate   DateTime? @map("start_date") @db.Date
  endDate     DateTime? @map("end_date") @db.Date

  // Client relationship
  clientId    String?  @map("client_id") @db.Uuid

  // Project manager
  managerId   String?  @map("manager_id") @db.Uuid

  // Budget configuration
  budgetType      ProjectBudgetType @default(FIXED) @map("budget_type")
  totalBudget     Decimal? @map("total_budget") @db.Decimal(10, 2)
  hourlyRate      Decimal? @map("hourly_rate") @db.Decimal(10, 2)
  estimatedHours  Decimal? @map("estimated_hours") @db.Decimal(10, 2)
  currency        String?  @default("USD")

  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  tenant          Tenant   @relation(fields: [tenantId], references: [id])
  client          Client?  @relation(fields: [clientId], references: [id])
  manager         Employee? @relation("ProjectManager", fields: [managerId], references: [id])

  members         ProjectMember[]
  timeEntries     TimeEntry[]
  budgets         ProjectBudget[]
  timeAllocations TimeAllocation[]

  @@map("projects")
}

model ProjectMember {
  id         String   @id @default(uuid()) @db.Uuid
  tenantId   String   @map("tenant_id") @db.Uuid
  projectId  String   @map("project_id") @db.Uuid
  employeeId String   @map("employee_id") @db.Uuid
  role       String?  @default("MEMBER") // simple string for now, or enum if robust needed
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz

  tenant     Tenant   @relation(fields: [tenantId], references: [id])
  project    Project  @relation(fields: [projectId], references: [id])
  employee   Employee @relation(fields: [employeeId], references: [id])

  @@unique([tenantId, projectId, employeeId])
  @@map("project_members")
}

model TimeEntry {
  id            String   @id @default(uuid()) @db.Uuid
  tenantId      String   @map("tenant_id") @db.Uuid
  employeeId    String   @map("employee_id") @db.Uuid
  projectId     String   @map("project_id") @db.Uuid
  date          DateTime @db.Date
  startTime     DateTime? @map("start_time") @db.Time
  endTime       DateTime? @map("end_time") @db.Time
  minutes       Int
  billable      Boolean  @default(true)
  description   String?
  source        TimeEntrySource @default(MANUAL)
  calendarEventId String? @map("calendar_event_id") @db.Uuid
  createdByUserId String   @map("created_by_user_id") @db.Uuid
  updatedByUserId String   @map("updated_by_user_id") @db.Uuid
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz

  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  employee      Employee @relation(fields: [employeeId], references: [id])
  project       Project  @relation(fields: [projectId], references: [id])
  calendarEvent CalendarEvent? @relation(fields: [calendarEventId], references: [id])
  createdBy     User     @relation("CreatedBy", fields: [createdByUserId], references: [id])
  updatedBy     User     @relation("UpdatedBy", fields: [updatedByUserId], references: [id])

  @@index([tenantId, employeeId, date])
  @@index([tenantId, projectId, date])
  @@map("time_entries")
}

model CalendarConnection {
  id                    String   @id @default(uuid()) @db.Uuid
  tenantId              String   @map("tenant_id") @db.Uuid
  userId                String   @map("user_id") @db.Uuid
  provider              CalendarProvider
  providerAccountId     String   @map("provider_account_id")
  scopes                String?
  accessTokenEncrypted  String?  @map("access_token_encrypted")
  refreshTokenEncrypted String?  @map("refresh_token_encrypted")
  tokenExpiresAt        DateTime? @map("token_expires_at") @db.Timestamptz
  status                ConnectionStatus @default(ACTIVE)
  lastSyncAt            DateTime? @map("last_sync_at") @db.Timestamptz
  syncCursor            String?  @map("sync_cursor") // For incremental sync (syncToken or deltaLink)
  createdAt             DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime @updatedAt @map("updated_at") @db.Timestamptz

  tenant        Tenant   @relation(fields: [tenantId], references: [id])
  user          User     @relation(fields: [userId], references: [id])
  subscriptions CalendarSubscription[]
  events        CalendarEvent[]

  @@unique([tenantId, userId, provider])
  @@map("calendar_connections")
}

model CalendarSubscription {
  id                     String   @id @default(uuid()) @db.Uuid
  tenantId               String   @map("tenant_id") @db.Uuid
  connectionId           String   @map("connection_id") @db.Uuid
  provider               CalendarProvider
  providerSubscriptionId String   @map("provider_subscription_id")
  resource               String?
  expiresAt              DateTime @map("expires_at") @db.Timestamptz
  status                 SubscriptionStatus @default(ACTIVE)
  createdAt              DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt              DateTime @updatedAt @map("updated_at") @db.Timestamptz

  tenant     Tenant             @relation(fields: [tenantId], references: [id])
  connection CalendarConnection @relation(fields: [connectionId], references: [id])

  @@map("calendar_subscriptions")
}

model CalendarEvent {
  id              String   @id @default(uuid()) @db.Uuid
  tenantId        String   @map("tenant_id") @db.Uuid
  connectionId    String   @map("connection_id") @db.Uuid
  provider        CalendarProvider
  providerEventId String   @map("provider_event_id")
  icalUid         String?  @map("ical_uid")
  title           String?
  startAt         DateTime @map("start_at") @db.Timestamptz
  endAt           DateTime @map("end_at") @db.Timestamptz
  timezone        String?
  isAllDay        Boolean  @default(false) @map("is_all_day")
  isRecurring     Boolean  @default(false) @map("is_recurring")
  recurrenceRule  String?  @map("recurrence_rule")
  location        String?
  organizer       String?
  attendeesCount  Int?     @map("attendees_count")
  updatedAtProvider DateTime? @map("updated_at_provider") @db.Timestamptz
  syncedAt        DateTime @default(now()) @map("synced_at") @db.Timestamptz

  tenant      Tenant             @relation(fields: [tenantId], references: [id])
  connection  CalendarConnection @relation(fields: [connectionId], references: [id])
  timeEntries TimeEntry[]

  @@unique([tenantId, connectionId, provider, providerEventId])
  @@index([tenantId, connectionId, startAt])
  @@map("calendar_events")
}

model ReportJob {
  id                String   @id @default(uuid()) @db.Uuid
  tenantId          String   @map("tenant_id") @db.Uuid
  requestedByUserId String   @map("requested_by_user_id") @db.Uuid
  type              ReportType
  params            Json?
  status            JobStatus @default(PENDING)
  fileKey           String?  @map("file_key")
  error             String?
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz

  tenant            Tenant   @relation(fields: [tenantId], references: [id])
  requestedByUser   User     @relation(fields: [requestedByUserId], references: [id])

  @@index([tenantId, createdAt])
  @@map("report_jobs")
}

model AuditLog {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  actorUserId String?  @map("actor_user_id") @db.Uuid
  action      String
  entityType  String   @map("entity_type")
  entityId    String   @map("entity_id")
  metadata    Json?
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz

  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  actorUser   User?    @relation(fields: [actorUserId], references: [id])

  @@index([tenantId, createdAt])
  @@map("audit_logs")
}

model Client {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid

  // Basic Information
  name        String
  code        String?

  // Contact Information
  email       String?
  phone       String?
  contactPerson String? @map("contact_person")

  // Address
  address     String?
  city        String?
  state       String?
  postalCode  String?  @map("postal_code")
  country     String?

  // Company Details
  companyRegistrationNumber String? @map("company_registration_number")
  taxId       String?  @map("tax_id")
  vatNumber   String?  @map("vat_number")

  // Billing Information
  defaultBillingRate Decimal? @map("default_billing_rate") @db.Decimal(10, 2)
  currency    String?  @default("USD")
  paymentTerms String? @map("payment_terms")

  // Contract Information
  contractStartDate DateTime? @map("contract_start_date") @db.Date
  contractEndDate   DateTime? @map("contract_end_date") @db.Date
  contractNotes     String?   @map("contract_notes")

  status      ClientStatus @default(ACTIVE)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  projects    Project[]

  @@unique([tenantId, code])
  @@map("clients")
}

model TimeAllocation {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  projectId   String   @map("project_id") @db.Uuid
  employeeId  String   @map("employee_id") @db.Uuid

  month       Int      // 1-12
  year        Int

  allocatedHours Decimal @map("allocated_hours") @db.Decimal(10, 2)
  notes       String?

  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  project     Project  @relation(fields: [projectId], references: [id])
  employee    Employee @relation(fields: [employeeId], references: [id])

  @@unique([tenantId, projectId, employeeId, year, month])
  @@index([tenantId, projectId, year, month])
  @@index([tenantId, employeeId, year, month])
  @@map("time_allocations")
}

model ProjectBudget {
  id          String   @id @default(uuid()) @db.Uuid
  tenantId    String   @map("tenant_id") @db.Uuid
  projectId   String   @map("project_id") @db.Uuid

  month       Int
  year        Int

  budgetAmount Decimal? @map("budget_amount") @db.Decimal(10, 2)
  budgetHours  Decimal? @map("budget_hours") @db.Decimal(10, 2)

  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  project     Project  @relation(fields: [projectId], references: [id])

  @@unique([tenantId, projectId, year, month])
  @@map("project_budgets")
}
